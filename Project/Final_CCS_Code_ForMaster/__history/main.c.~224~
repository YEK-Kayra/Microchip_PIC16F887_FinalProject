//Ister bisiklet ol ister tir, ne olursan ol yine gel

#include <16f887.h>

/********************************************************/
/*               SYSTEM DEVICES                         */
/********************************************************/
#device ADC = 10


/********************************************************/
/*               SYSTEM USES                            */
/********************************************************/
#use delay(clock=4M) 
#use rs232(baud=9600,parity=N,uart1,bits=8)
#use fast_io(b)

/********************************************************/
/*               SYSTEM INCLUDES                        */
/********************************************************/
#include <lcd.c>    
#include <math.h>       
                                       
/********************************************************/
/*               SYSTEM FUSES                           */
/********************************************************/                                         
#fuses HS,NOWDT,NOPUT,NOLVP,NOCPD,NOPROTECT,NODEBUG,NOBROWNOUT,NOWRT


/********************************************************/
/*               SYSTEM REGISTER                        */
/********************************************************/
//!#byte my_TIM0_OPTION_REG = 0x81 
//!#byte my_TIM0_MODULE_REG = 0x01 
//!#byte my_INTCON_REG      = 0x0B


/********************************************************/
/*               SYSTEM STRUCTS                         */
/********************************************************/
typedef struct{

   unsigned int8 time_Foaming;
   unsigned int8 time_Washing;
   unsigned int8 time_Ventilation;
   unsigned int8 time_Polishing;

}MikroleumClient_HandleTypeDef;



/********************************************************/
/*               SYSTEM VARIABLES                       */
/********************************************************/
//-VAR-->CRITICAL PART
char readed_ID;   //Coming data will be When came from slave PIC
int8 systemLock;  //If the ID is valid, system open. Otherwise it will remain locked
int8 OPS_Status;  //55 means ops will be canceled, otherwise ops will be going on

//-VAR-->Keeps Clients
MikroleumClient_HandleTypeDef MikroClient[2]; //Each customer keeps their own records

//-VAR-->POTENTIOMETERS
int Index_OptionMenu;
unsigned long int val_ADC_Pot_Surf;



/********************************************************/
/*               SYSTEM DEFINATION                      */
/********************************************************/
/* ======== SYSTEM INPUT & OUTPUT ======== */
#define button_NEXT           pin_A3
#define button_BACK           pin_A4
#define button_Select         pin_A5
#define button_RemoveSelect   pin_C0
#define button_OPS_START      pin_C1
#define button_OPS_CANCEL     pin_B0


/********************************************************/
/*               FUNCTIONS PROTOTYPES                   */
/********************************************************/
/* ======== SYSTEM CONFIGURATION FUNCTIONS PROTOTYPES  ======== */
void SubSystem_Init(void);
void trisSetting_Init(void);
void interruptSetting_Init(void);
void adcSetting_Init(void);

/* ======== LCD SCREEN FUNCTIONS PROTOTYPES  ======== */
void SubSystem_lcd_IdleStatus(void);
void NavigateOperationMenu(void);
void NavigateTimeMoneyPreferenceMenu(void);

/* ======== UART SERIAL COM. FUNCTIONS PROTOTYPES  ======== */
void SubSystem_uart_CheckTheMessage(void);


/********************************************************/
/*               SYSTEM MACROS                          */
/********************************************************/
#define ADC_TO_INDEXofOPTION_MENU(val_ADC_Pot_Surf) \
   do{                                        \
          Index_OptionMenu = ((val_ADC_Pot_Surf*5)/1020);  \
          if(Index_OptionMenu >= 5){ \
            Index_OptionMenu = 4;    \
          }                            \
   }while(0)


/********************************************************/
/*               SYSTEM INTERRUPTS                      */
/********************************************************/
#int_EXT
void system_isr_OperationCANCEL(){
  OPS_Status = 55;
}
//Timer kesmleri



void main(void) 
{
  
   //-->System parameters will be initialized
   SubSystem_Init();
      
   //-->Wait until unlock the system
   do{
        SubSystem_lcd_IdleStatus();   //Greeting the customer
        
        if(kbhit())
        {
           readed_ID = getc();
           SubSystem_uart_CheckTheMessage();
        }      
        
    }while(systemLock!=1);
 
    delay_ms(3000);
  
      //Potansiyometreden deðerler okuyacak, opsiyonlarý gezmek için
      //ileri butonuna basýlýnca pot hangi opsiyonda ise o opsiyona gidilecek
      //geri butonuna basýlýnca pot ile tekrardan yukardan aþaðý gezilebilecek
      //diyelim ki bir opsiyonun içine girdi, pot kullanarak zamanlama ayarlarý ile oynuyor, 
      //çift týk ile ilgili zaman ve ücreti seçebilecek, tek týk ile de bozabilecek
      do{
      
       //Get Surf_Pot ADC value(0-1024)
       val_ADC_Pot_Surf = read_adc();  
       
       //Convert Surf_Pot ADC value into the option menu index
       ADC_TO_INDEXofOPTION_MENU(val_ADC_Pot_Surf);
      
       //Use index value to show selected option and other one
       NavigateOperationMenu();
       
       delay_ms(500);
  
      }while(OPS_Status!=55);
        
       
    while(1)
    {
    
   
   
    }
 
 
}


/* ======== -BEGIN- SYSTEM CONFIGURATION FUNCTIONS -BEGIN- ======== */
//Function-1
void SubSystem_Init(void){
 lcd_init();
 trisSetting_Init();
 interruptSetting_Init();
 adcSetting_Init();
}

//Function-2
void trisSetting_Init(){
   set_tris_b(0x01);
}

//Function-3
void interruptSetting_Init(){
     //-CONFIG--> OPERATION CANCEL BUTTON 
       ext_int_edge(L_TO_H); //Harici kesme Lojik 0'dan 1'e geçerken
       enable_interrupts(INT_EXT); //Harici kesme aktif
       enable_interrupts(GLOBAL); //Aktif kesmeler için genel kesme yetkisi ver
     //-CONFIG--> TIMER0 
}

//Function-4
void adcSetting_Init(){
     //-CONFIG--> Surfing Potentiometer
        setup_adc(adc_clock_div_32); 
        setup_adc_ports(sAN0);
        set_adc_channel(0); 
        delay_us(200);
        
     //-CONFIG--> Timer Potentiometer
     //-CONFIG--> Process Intensity Potentiometer
}

/* ======== -END- SYSTEM CONFIGURATION FUNCTIONS -END- ======== */




/* ======== -BEGIN- LCD SCREEN FUNCTIONS -BEGIN- ======== */
/**
 *@brief :It sequentially displays a welcome message and 
 *        prompts the user to present their ID card.
 */
void SubSystem_lcd_IdleStatus(void){
      printf(lcd_putc,"\f");
      lcd_gotoxy(4,1);
      printf(lcd_putc,"Mikroleum'a");
      lcd_gotoxy(4,2);
      printf(lcd_putc,"Hosgeldiniz");
      delay_ms(500);
      printf(lcd_putc,"\f");
      
      lcd_gotoxy(1,1);
      printf(lcd_putc,"Lutfen ID Karti");
      lcd_gotoxy(4,2);
      printf(lcd_putc,"Gosteriniz");
      delay_ms(500);
      printf(lcd_putc,"\f");
}

//Function-2
void NavigateOperationMenu(void){
printf(lcd_putc, "\f"); // LCD'yi temizle

    // 1. Seçenek
    if (Index_OptionMenu == 0) {
        lcd_gotoxy(1, 1);
        printf(lcd_putc, "1-Kopuk Islem <-");
        lcd_gotoxy(1, 2);
        printf(lcd_putc, "2-Su Islem");   
    } 

    // 2. Seçenek
    if (Index_OptionMenu == 1) {
        lcd_gotoxy(1, 1);
        printf(lcd_putc, "2-Su Islem <-");
        lcd_gotoxy(1, 2);
        printf(lcd_putc, "3-Hava Islem");       
    }
    
    // 3. Seçenek
        if (Index_OptionMenu == 2) {
        lcd_gotoxy(1, 1);
        printf(lcd_putc, "3-Hava Islem <-");
        lcd_gotoxy(1, 2);
        printf(lcd_putc, "4-Cila Islem");   
    } 

    // 4. Seçenek
    if (Index_OptionMenu == 3) {
        lcd_gotoxy(1, 1);
        printf(lcd_putc, "4-Cila Islem <-");
        lcd_gotoxy(1, 2);
        printf(lcd_putc, "5-Kayit Islem");    
    }
    
    // 5. Seçenek
    if (Index_OptionMenu == 4) {
        lcd_gotoxy(1, 1);
        printf(lcd_putc, "5-Kayit Islem <-"); 
    }


}

//Function-3
void NavigateTimeMoneyPreferenceMenu(void){
}

/* ======== -END- LCD SCREEN FUNCTIONS -END- ======== */




/* ======== -BEGIN- UART PROTOCOL FUNCTIONS -BEGIN- ======== */
/**
 *@brief : This function checks the `readed_ID` variable to determine 
 *         the action to take based on predefined identifiers. Depending on the identifier,
 *         it displays a welcome message for specific users or sets the system to an idle state.
 */
void SubSystem_uart_CheckTheMessage(void){
   
   if(readed_ID == '+'){      //Mr. Selçuk's ID
   
      lcd_gotoxy(4,1);
      printf(lcd_putc,"Hosgeldiniz");
      lcd_gotoxy(4,2);
      printf(lcd_putc,"Selcuk Bey");
      systemLock = 1;
   }
   else if(readed_ID == '*'){ //Mr. Emre's ID
   
      lcd_gotoxy(4,1);
      printf(lcd_putc,"Hosgeldiniz");
      lcd_gotoxy(4,2);
      printf(lcd_putc,"Emre Bey");
      systemLock = 1;
   }
   else if(readed_ID == '.'){ //Slave pic is idle status
   
       systemLock = 0;
   }

}
/* ======== -END- UART PROTOCOL FUNCTIONS -END- ======== */
